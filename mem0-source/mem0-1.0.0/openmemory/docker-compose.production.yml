# Production Docker Compose for OpenMemory Stack
# This configuration uses pre-built Docker Hub images
# No volume mounts for code - everything is baked into images
# 
# Usage:
#   1. Set environment variables (see .env.example)
#   2. docker compose -f docker-compose.production.yml up -d
#
# Required Environment Variables:
#   - GOOGLE_API_KEY or GEMINI_API_KEY (for Gemini LLM)
#   - USER (optional, defaults to 'default')
#   - API_KEY (optional, for API authentication)

version: '1.01'
services:
  openmemory-mcp:
    # Replace 'your-dockerhub-username' with your actual Docker Hub username
    image: your-dockerhub-username/openmemory-mcp-gemini:latest
    container_name: openmemory-mcp
    ports:
      - "8765:8765"
    environment:
      - USER=${USER:-default}
      - QDRANT_HOST=mem0_store
      - QDRANT_PORT=6333
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-mem0graph}
      - DATABASE_URL=sqlite:///./data/openmemory.db
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - API_KEY=${API_KEY:-}
    # Persistent volume for SQLite database (data only, not code)
    volumes:
      - openmemory_data:/usr/src/openmemory/data
    depends_on:
      neo4j:
        condition: service_healthy
      mem0_store:
        condition: service_started
    restart: unless-stopped
    networks:
      - openmemory_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  openmemory-ui:
    # Replace 'your-dockerhub-username' with your actual Docker Hub username
    image: your-dockerhub-username/openmemory-ui-gemini:latest
    container_name: openmemory-ui
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_USER_ID=${USER:-default}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8765}
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
    depends_on:
      - openmemory-mcp
    restart: unless-stopped
    networks:
      - openmemory_network

  mem0_store:
    image: qdrant/qdrant:latest
    container_name: openmemory-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      # Persistent volume for Qdrant vector data
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped
    networks:
      - openmemory_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  neo4j:
    image: neo4j:5.26.4
    container_name: openmemory-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7473:7473"  # HTTPS
      - "7687:7687"  # Bolt
    volumes:
      # Persistent volumes for Neo4j data and logs
      - neo4j_data:/data
      - neo4j_logs:/logs
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-mem0graph}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p ${NEO4J_PASSWORD:-mem0graph} 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - openmemory_network

volumes:
  # Qdrant vector store data
  qdrant_storage:
    driver: local
  # OpenMemory SQLite database
  openmemory_data:
    driver: local
  # Neo4j graph database
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local

networks:
  openmemory_network:
    driver: bridge




