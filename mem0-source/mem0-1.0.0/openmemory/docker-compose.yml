services:
  openmemory-mcp:
    image: mem0/openmemory-mcp
    container_name: openmemory-openmemory-mcp-1
    ports:
      - "8765:8765"
    volumes:
      - ./api:/usr/src/openmemory:rw
    env_file:
      - .env
    environment:
      - USER=${USER:-default}
      - QDRANT_HOST=${QDRANT_HOST:-mem0_store}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-mem0graph}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./openmemory.db}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - API_KEY=${API_KEY:-}
    command: sh -c "uvicorn main:app --host 0.0.0.0 --port 8765 --reload --workers 4"
    working_dir: /usr/src/openmemory
    depends_on:
      neo4j:
        condition: service_healthy
      mem0_store:
        condition: service_started
    restart: unless-stopped
    networks:
      - openmemory_default

  openmemory-ui:
    image: mem0/openmemory-ui:latest
    container_name: openmemory-openmemory-ui-1
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_USER_ID=default
      - NEXT_PUBLIC_API_URL=http://localhost:8765
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
    restart: unless-stopped
    networks:
      - openmemory_default

  mem0_store:
    image: qdrant/qdrant
    container_name: openmemory-mem0_store-1
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - /home/otto_cs_03/docker/qdrant/qdrant_storage:/qdrant/storage
    restart: unless-stopped
    networks:
      - openmemory_default

  neo4j:
    image: neo4j:5.26.4
    container_name: neo4j
    ports:
      - "7474:7474"
      - "7473:7473"
      - "7687:7687"
    volumes:
      - mem0-dev_neo4j_data:/data
      - mem0-dev_neo4j_logs:/logs
    environment:
      - NEO4J_AUTH=neo4j/mem0graph
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p mem0graph 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - openmemory_default

volumes:
  mem0-dev_neo4j_data:
    external: true
  mem0-dev_neo4j_logs:
    external: true

networks:
  openmemory_default:
    external: false
